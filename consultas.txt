CREATE TRIGGER CREAR_FACTURA_FIN_DE_MES AFTER FIN_MES ON CLIENTE
FOR EACH ROW
BEGIN
  INSERT INTO FACTURAS
  (noFactura, noIdentidad, mes, aÃ±o, monto)
  VALUES (SEQ_FACTURAS.NEXT, OLD.noIdentidad, DATE.MONTH, DATE.YEAR, 0);
END

CREATE TRIGGER ACTUALIZAR_FACTURA AFTER INSERT ON LLAMADAS_TELEFONICA
FOR EACH ROW
DECLARE
  var_codigo_plan INTEGER;
  var_precioSegundo INTEGER;
BEGIN

  SET @var_codigo_plan := (SELECT plan FROM CLIENTES WHERE noIdentidad = NEW.noIdentidad);
  SET @var_precioSegundo := (SELECT precioSegundo FROM PLANES_PRECIOS WHERE codigo = @var_codigo_plan);

  UPDATE FACTURAS SET monto = monto + NEW.segundos * @var_precioSegundo
  WHERE noIdentidad = NEW.noIdentidad;
END

CREATE PROCEDURE INSERTAR_EMPLEADO_A_PLANTILLA (
  var_in_num_empleado INTEGER,
  var_in_oficio VARCHAR2,

  var_in_salario FLOAT,
  var_in_turno VARCHAR2,

  var_in_nombre_hospital VARCHAR2,
  var_in_nombre_sala VARCHAR2
)
DECLARE
  var_local_codigo_sala INTEGER;
  var_local_codigo_hospital INTEGER;

BEGIN
  SET @var_local_codigo_sala := (SELECT codSala FROM SALAS WHERE nombre = @var_in_nombre_sala);
  SET @var_local_codigo_hospital := (SELECT codHospital FROM HOSPITALES WHERE nombre = @var_in_nombre_hospital);

  IF (COUNT(SELECT * FROM PLANTILLAS WHERE noEmpleado = @var_in_num_empleado) > 0) THEN
    RETURN;
  END IF;

  IF (@var_local_codigo_hospital = NULL) THEN
    RETURN;
  END IF;

  IF (@var_local_codigo_sala = NULL) THEN
    RETURN;
  END IF;

  IF (COUNT(SELECT * FROM SALAS WHERE codHospital = @var_local_codigo_hospital AND codSala = @var_local_codigo_sala) = 0) THEN
    RETURN;
  END IF;

  IF (COUNT(SELECT * FROM EMPLEADOS WHERE oficio = @var_in_oficio) = 0) THEN
    RETURN;
  END IF;

  IF (COUNT(SELECT * FROM PLANTILLAS WHERE turno = @var_in_turno) = 0) THEN
    RETURN;
  END IF;

  IF (@var_in_salario > 500000) THEN
    RETURN;
  END IF;

  COMMIT;
END
